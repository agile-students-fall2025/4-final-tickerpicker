name: CD

on:
  workflow_run:
    workflows: ["CI"]
    branches: [ master, main ]
    types: [ completed ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to DigitalOcean
    runs-on: ubuntu-latest
    environment: production
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    env:
      DEPLOY_SHA: ${{ github.event.workflow_run.head_sha || github.sha }}

    steps:
      - name: Checkout (for metadata only)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEPLOY_SHA }}

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: ${{ secrets.DO_PORT }}
          script: |
            set -e
            
            echo "Deploying commit: $DEPLOY_SHA"
            
            cd $DEPLOY_PATH
            
            # Pull latest code
            git fetch --all --prune
            git reset --hard $DEPLOY_SHA
            
            # Rebuild and restart Docker containers
            docker compose down
            docker compose build --no-cache
            docker compose up -d
            
            # Clean up old images to save space
            docker system prune -f
            
            # Verify deployment
            docker compose ps
            echo "Deployment completed successfully!"
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
