name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
      
      - name: Install root dependencies
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi
        working-directory: .
      
      - name: Install back-end dependencies
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi
        working-directory: back-end
      
      - name: Run back-end tests
        run: npm test
        working-directory: back-end
        env:
          NODE_ENV: test
      
      - name: Build front-end
        run: npm run build
        working-directory: .
      
      - name: Verify build artifacts
        run: |
          if [ -d "dist" ]; then
            echo "✓ Build artifacts found in dist/"
            ls -la dist/ | head -10
          elif [ -d "front-end/dist" ]; then
            echo "✓ Build artifacts found in front-end/dist/"
            ls -la front-end/dist/ | head -10
          else
            echo "Error: Front-end build did not create expected dist directory"
            echo "Checking for any build output..."
            find . -name "dist" -type d 2>/dev/null || echo "No dist directory found"
            exit 1
          fi

